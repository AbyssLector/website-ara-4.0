<?php

namespace App\Controllers\dashboard;

use App\Controllers\BaseController;

use App\Models\ExploitModel;
use App\Models\UserModel;

class AdminExploit extends BaseController
{
    protected $session;
    protected $db;
    protected $Exploit_Model;
    protected $User_Model;
    public function __construct()
    {
        $this->session = \Config\Services::session();
        $this->db = \Config\Database::connect();
        $this->Exploit_Model = new ExploitModel();
        $this->User_Model = new UserModel();
    }
    public function is_pass_same($pass)
    {
        $builder = $this->db->table('user');
        $builder->where('user_password', $pass);
        return !empty($builder->get()->getResult());
    }
    public function delete_file($path, $filename)
    {
        if (!empty($filename))
            unlink($path . $filename);
        return;
    }
    public function konfirmasi_team()
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }
        $data =
            [
                'title' => 'Admin ExploIT',
                'nama' => 'Admin ExploIT',
                'event' => 'ExploIT',
                'step' => 'Konfirmasi',
                'team_list' => $this->Exploit_Model->where('exploit_status', 0)->findAll(),
                'terkonfirmasi' => $this->Exploit_Model->where('exploit_status', 1)->countAllResults(),
                'belum_terkonfirmasi' => $this->Exploit_Model->where('exploit_status', 0)->countAllResults(),
                'total_team' => $this->Exploit_Model->where('exploit_status', 0)->countAllResults() + $this->Exploit_Model->where('exploit_status', 1)->countAllResults(),
            ];
        return view('landing/pages/dashboard/admin/exploit/konfirmasi_team', $data);
    }
    public function confirmed_team()
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }
        $data =
            [
                'title' => 'Admin ExploIT',
                'nama' => 'Admin ExploIT',
                'event' => 'ExploIT',
                'step' => 'Terkonfirmasi',
                'team_list' => $this->Exploit_Model->where('exploit_status', 1)->findAll(),
                'terkonfirmasi' => $this->Exploit_Model->where('exploit_status', 1)->countAllResults(),
                'belum_terkonfirmasi' => $this->Exploit_Model->where('exploit_status', 0)->countAllResults(),
                'total_team' => $this->Exploit_Model->where('exploit_status', 0)->countAllResults() + $this->Exploit_Model->where('exploit_status', 1)->countAllResults(),
            ];
        return view('landing/pages/dashboard/admin/exploit/list_team', $data);
    }
    public function verify_konfirmasi_team($id, $status) 
    {
        if (!$this->session->get('is_admin')) {
            return redirect()->to('/auth/login');
        }
        if (!$this->session->get('username')) {
            return redirect()->to('/auth/login');
        }
        helper('text');
        $team = $this->Exploit_Model->where('exploit_tim_id', $id)->first();

        if($status) {
            $password = random_string('special_alnum', 12);

            if($this->is_pass_same($password)) {
                return redirect()->to('dashboard/admin-exploit/verify-konfirmasi-team/' . $id . '/1');
            } else {
                $data = [
                    'user_lomba'       => 'exploit',
                    'user_tim_nama'    => $team['exploit_tim_nama'],
                    'user_username'    => 'exploit' . '_' . $team['exploit_tim_nama'],
                    'user_password'    => password_hash($password, PASSWORD_DEFAULT)
                ];

                $subject = "[Accepted] Exploit";
                $message = "Halo {$team['exploit_tim_nama']} dari {$team['exploit_asal_institusi']},<br>
                  <br>
                  Terima kasih sudah mendaftar pada event kami, \"Exploit.\"<br>
                  <br>
                  Berikut adalah Username dan Password anda: <br>
                  <br>
                  Username : {$data['user_username']}<br>
                  Password : {$password}<br><br>
                  <br>
                  --<br>
                  Salam Hormat,<br>
                  <br>
                  A Renewal Agents 4.0";
                $email = \Config\Services::email();
                $email->setTo($team['exploit_email']);
                $email->setFrom('arenewalagent@gmail.com', 'ARA 4.0');
                $email->setSubject($subject);
                $email->setMessage($message);

                if ($email->send()) {
                    $data_status = [
                        'exploit_tim_id' => $team['exploit_tim_id'],
                        'exploit_status' => 1
                    ];
                    $this->Exploit_Model->save($data_status);
                    $this->User_Model->save($data);
                    $this->session->setFlashdata('msg', 'Berhasil Menerima Tim: ' . $team['exploit_tim_nama']);
                } else {
                    $this->session->setFlashdata('msg', 'Server Error');
                }
            }
        } else {
            $surat_kontrak_path = 'uploads/exploit/surat_kontrak/';
            $suket_path = 'uploads/exploit/identitas/';

            $subject = "[Rejected] Exploit";
            $message = "Halo {$team['exploit_tim_nama']} dari {$team['exploit_asal_institusi']},<br>
            <br>
            Terima kasih sudah mendaftar pada event kami, \"Exploit.\"<br>
            <br>
            Mohon maaf, persyaratan yang anda kirimkan tidak cukup. Mohon mendaftar kembali di halaman registrasi.<br>
            <br>
            <br>
            --<br>
            Salam Hormat,<br>
            <br>
            A Renewal Agents 4.0";
            $email = \Config\Services::email();
            $email->setTo($team['exploit_email']);
            $email->setFrom('arenewalagent@gmail.com', 'ARA 4.0');
            $email->setSubject($subject);
            $email->setMessage($message);
            if ($email->send()) {
                $this->delete_file($surat_kontrak_path, $team['exploit_surat_kontrak']);

                $this->delete_file($suket_path, $team['exploit_suket_ketua']);

                if ($team['exploit_suket_anggota_1'] != null) {
                    $this->delete_file($suket_path, $team['exploit_suket_anggota_1']);
                }

                if ($team['exploit_suket_anggota_2'] != null) {
                    $this->delete_file($suket_path, $team['exploit_suket_anggota_2']);
                }

                if ($team['exploit_suket_anggota_3'] != null) {
                    $this->delete_file($suket_path, $team['exploit_suket_anggota_3']);
                }

                if ($team['exploit_suket_anggota_4'] != null) {
                    $this->delete_file($suket_path, $team['exploit_suket_anggota_4']);
                }

                $this->Exploit_Model->where('exploit_tim_id', $id)->delete();
                $this->session->setFlashdata('msg', 'Berhasil Menolak Tim: ' . $team['exploit_tim_nama']);
            } else {
                $this->session->setFlashdata('msg', 'Server Error');
            }
        }
        return redirect()->to('dashboard/admin-exploit/konfirmasi-team');
    }
}